<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Case Schedule - Advocate Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <style>
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: #f1f5f9;
    }

    .table-container {
      overflow-x: auto;
    }

    .scrollable-card::-webkit-scrollbar {
      display: none;
    }

    .status-filed {
      @apply bg-blue-100 text-blue-700;
    }

    .status-hearing {
      @apply bg-amber-100 text-amber-700;
    }

    .status-judgment {
      @apply bg-purple-100 text-purple-700;
    }

    .status-disposed {
      @apply bg-emerald-100 text-emerald-700;
    }

    .status-adjourned {
      @apply bg-red-100 text-red-700;
    }

    .status-default {
      @apply bg-gray-100 text-gray-700;
    }

    @media print {
      .print-hidden {
        display: none !important;
      }
    }
  </style>
</head>

<body class="text-slate-800">
  <nav class="bg-slate-900 text-white sticky top-0 z-30 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <div class="flex items-center gap-3">
          <div class="bg-teal-500 text-white p-1.5 rounded-lg"><i class="fa-solid fa-scale-balanced text-lg"></i></div>
          <a href="index.html" class="font-bold text-xl tracking-tight hover:text-teal-400 transition">LegalMate</a>
        </div>
        <div class="flex items-center gap-4">
          <a href="index.html"
            class="bg-teal-600 hover:bg-teal-500 text-white text-sm font-bold py-2 px-4 rounded-lg transition shadow-lg shadow-teal-900/50 flex items-center"><i
              class="fa-solid fa-plus mr-2"></i> New Case</a>
          <button id="sign-out-btn" class="text-red-500 hover:text-red-400 font-medium text-lg transition"
            title="Sign Out"><i class="fa-solid fa-power-off"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div
        class="bg-gradient-to-br from-green-700 to-green-900 rounded-xl shadow-lg p-5 text-white relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-regular fa-clock text-6xl"></i></div>
        <p class="text-xs font-bold text-green-100 uppercase tracking-wider mb-1">Tomorrow's Postings</p>
        <h3 class="text-3xl font-bold" id="widget-tomorrow-count">0</h3>
        <div id="tomorrow-cases-list-widget" class="mt-2 text-sm text-green-100 truncate h-6">No postings tomorrow</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Active Cases</p>
            <h3 class="text-3xl font-bold text-slate-900 mt-1" id="widget-active-count">0</h3>
          </div>
          <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i class="fa-solid fa-gavel"></i></div>
        </div>
        <p class="text-xs text-slate-400 mt-2">Total registered cases</p>
      </div>
      <div id="alert-widget-container"
        class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 border-l-4 border-l-orange-500">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-xs font-bold text-orange-600 uppercase tracking-wider">Pending Tasks</p>
            <h3 class="text-3xl font-bold text-slate-900 mt-1" id="widget-alert-count">0</h3>
          </div>
          <div class="p-2 bg-orange-50 text-orange-600 rounded-lg"><i class="fa-regular fa-bell"></i></div>
        </div>
        <div id="alert-panel" class="hidden mt-2">
          <div id="today-alerts-list" class="space-y-2 mt-2 max-h-24 overflow-y-auto pr-1"></div>
        </div>
      </div>
    </div>

    <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
      <div class="p-5 border-b border-slate-100 bg-slate-50/50">
        <div class="flex flex-col xl:flex-row justify-between gap-4">
          <div class="relative w-full xl:w-1/3"><input type="text" id="searchCaseNumber" placeholder="Search Case No..."
              class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 bg-white text-sm focus:ring-2 focus:ring-teal-500 focus:outline-none"><i
              class="fa-solid fa-magnifying-glass absolute left-3.5 top-3 text-slate-400 text-sm"></i></div>
          <div class="flex flex-wrap gap-2 w-full xl:w-2/3 justify-start xl:justify-end items-center">
            <input type="date" id="filterDateFrom" class="p-2 border border-slate-300 rounded-lg text-xs"
              title="From Date" />
            <span class="text-slate-400 text-xs">to</span>
            <input type="date" id="filterDateTo" class="p-2 border border-slate-300 rounded-lg text-xs"
              title="To Date" />
            <select id="filterAdvocate" class="p-2 border border-slate-300 rounded-lg text-xs bg-white min-w-[120px]">
              <option value="">All Advocates</option>
            </select>
            <input type="text" id="searchClientName" placeholder="Client Name"
              class="p-2 border border-slate-300 rounded-lg text-xs w-28" />
            <input type="text" id="searchCourtName" placeholder="Court Name"
              class="p-2 border border-slate-300 rounded-lg text-xs w-28" />
            <button id="clear-filter" class="p-2 text-slate-500 hover:text-red-500 transition" title="Clear Filters"><i
                class="fa-solid fa-filter-circle-xmark text-lg"></i></button>
          </div>
        </div>
        <div id="report-buttons-container" class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-slate-200 hidden">
          <span class="text-xs font-bold text-slate-400 uppercase self-center mr-2">Generate Reports:</span>
          <button id="generate-schedule-report"
            class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-3 py-1.5 rounded shadow">Schedule
            (Future)</button>
          <button id="generate-history-report"
            class="bg-slate-700 hover:bg-slate-800 text-white text-xs font-bold px-3 py-1.5 rounded shadow border border-slate-600">History
            (Filtered)</button>
          <button id="generate-payment-report"
            class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-1.5 rounded shadow">Payments</button>
          <button id="generate-advocate-report"
            class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold px-3 py-1.5 rounded shadow">Advocates</button>
          <button id="generate-status-report"
            class="bg-orange-600 hover:bg-orange-700 text-white text-xs font-bold px-3 py-1.5 rounded shadow">Status</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-100 text-sm">
          <thead class="bg-slate-50 text-slate-500 font-semibold uppercase text-xs">
            <tr>
              <th class="px-6 py-4 text-left">Case Details</th>
              <th class="px-6 py-4 text-left">Client Info</th>
              <th class="px-6 py-4 text-left">Next Date</th>
              <th class="px-6 py-4 text-left">Status</th>
              <th class="px-6 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="cases-list" class="divide-y divide-slate-100 bg-white">
            <tr>
              <td colspan="5" class="px-6 py-10 text-center text-slate-400" id="loading-message"><i
                  class="fa-solid fa-circle-notch fa-spin mr-2"></i> Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 text-xs text-slate-500 flex justify-between"><span
          id="case-count">0 Cases found</span><span>Showing latest first</span></div>
    </div>

    <div id="edit-modal"
      class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div
        class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full overflow-y-auto max-h-[90vh] border border-slate-200">
        <h3 class="text-xl font-bold mb-4 text-slate-800 border-b pb-2">Edit Case Details</h3>
        <form id="edit-case-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4"><input type="hidden" id="edit-caseId" />
          <div class="sm:col-span-2"><label class="text-xs font-bold text-slate-500 uppercase">Case Number</label><input
              type="text" id="edit-caseNumber" readonly
              class="w-full p-2 border bg-slate-100 font-bold rounded text-slate-600 focus:outline-none" /></div>
          <div><label class="text-xs text-slate-500">Advocate</label><input type="text" id="edit-advocateName" required
              class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Court</label><input type="text" id="edit-courtName" required
              class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Client</label><input type="text" id="edit-clientName" required
              class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Contact</label><input type="tel" id="edit-contactNumber"
              class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Alt Contact</label><input type="tel"
              id="edit-alternativeContactNumber" class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Email</label><input type="email" id="edit-clientEmail"
              class="w-full p-2 border rounded" /></div>
          <div class="sm:col-span-2"><label class="text-xs text-slate-500">Address</label><textarea
              id="edit-clientAddress" rows="2" class="w-full p-2 border rounded resize-none"></textarea></div>
          <div><label class="text-xs text-slate-500">Pincode</label><input type="text" id="edit-clientPincode"
              class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Date</label><input type="date" id="edit-scheduledDate"
              class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Status</label><select id="edit-caseStatus" required
              class="w-full p-2 border rounded bg-white">
              <option value="Filed">Filed</option>
              <option value="Hearing">Hearing</option>
              <option value="Judgment Reserved">Judgment Reserved</option>
              <option value="Disposed">Disposed</option>
              <option value="Adjourned">Adjourned</option>
              <option value="Achieved">Achieved</option>
              <option value="Give up">Give up</option>
            </select></div>
          <div><label class="text-xs text-slate-500">Referred By</label><input type="text" id="edit-referralName"
              class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Opp. Advocate</label><input type="text" id="edit-oppositeAdvocate"
              class="w-full p-2 border rounded" /></div>
          <div><label class="text-xs text-slate-500">Opp. Mobile</label><input type="tel"
              id="edit-oppositeAdvocateMobile" class="w-full p-2 border rounded" /></div>
          <div class="sm:col-span-2 flex justify-end gap-2 mt-4 border-t pt-4"><button type="button"
              id="edit-modal-cancel"
              class="bg-slate-200 text-slate-700 font-semibold px-4 py-2 rounded hover:bg-slate-300 text-sm">Cancel</button><button
              type="submit" class="bg-teal-600 text-white font-bold px-6 py-2 rounded hover:bg-teal-700 text-sm">Update
              Case</button></div>
        </form>
      </div>
    </div>

    <div id="report-modal"
      class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full flex flex-col max-h-[95vh]">
        <div class="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-xl print-hidden">
          <div>
            <h3 class="text-xl font-bold text-slate-800" id="report-case-title">Report</h3>
            <p class="text-sm text-slate-500" id="report-client-subtitle"></p>
          </div><button id="report-modal-close" class="text-slate-400 hover:text-red-500 text-2xl"><i
              class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-6 overflow-y-auto custom-scrollbar">
          <div class="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
            <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Client Details</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm text-slate-700"
              id="report-client-details"></div>
          </div>
          <div class="mb-8">
            <h4 class="font-bold text-teal-700 mb-2 border-b pb-1">Posting History</h4>
            <div class="bg-teal-50 p-4 rounded-lg border border-teal-100 mb-4 print-hidden">
              <form id="add-history-form" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div><label class="text-xs font-semibold text-teal-800 block mb-1">Hearing Date</label><input
                    type="date" id="current-hearing-date" required class="w-full p-2 border rounded text-sm bg-white" />
                </div>
                <div><label class="text-xs font-semibold text-teal-800 block mb-1">Next Posting Date</label><input
                    type="date" id="history-date" required class="w-full p-2 border rounded text-sm bg-white" /></div>
                <div><label class="text-xs font-semibold text-teal-800 block mb-1">Status</label><select
                    id="history-status" required class="w-full p-2 border rounded text-sm bg-white">
                    <option value="" disabled selected>Select Status</option>
                    <option value="Filed">Filed</option>
                    <option value="Hearing">Hearing</option>
                    <option value="Adjourned">Adjourned</option>
                    <option value="Judgment Reserved">Judgment Reserved</option>
                    <option value="Disposed">Disposed</option>
                    <option value="Achieved">Achieved</option>
                    <option value="Give up">Give up</option>
                  </select></div>
                <div><label class="text-xs font-semibold text-teal-800 block mb-1">Appeared Advocate</label><select
                    id="history-advocate" class="w-full p-2 border rounded text-sm bg-white">
                    <option value="" disabled selected>Select Advocate</option>
                  </select></div>
                <div class="sm:col-span-2"><label
                    class="text-xs font-semibold text-teal-800 block mb-1">Remarks</label><input type="text"
                    id="history-remarks" placeholder="Enter details..." required
                    class="w-full p-2 border rounded text-sm" /></div><button type="submit"
                  class="sm:col-span-2 bg-teal-600 text-white font-bold py-2 rounded hover:bg-teal-700 shadow-sm text-sm">Update
                  History & Next Date</button>
              </form>
            </div>
            <table class="w-full text-sm text-left">
              <thead class="bg-slate-100 text-xs uppercase">
                <tr>
                  <th class="p-2">Hearing Date</th>
                  <th class="p-2">Advocate</th>
                  <th class="p-2">Status / Remarks</th>
                  <th class="p-2">Next Posting</th>
                </tr>
              </thead>
              <tbody id="hearing-history-body" class="divide-y"></tbody>
            </table>
            <p id="no-history-msg" class="text-xs text-slate-400 mt-2 text-center italic">No history recorded.</p>
          </div>
          <div class="mb-6">
            <div class="flex justify-between items-center border-b pb-1 mb-2">
              <h4 class="font-bold text-orange-600">Reminders</h4>
            </div>
            <div class="bg-orange-50 p-3 rounded mb-3 print-hidden border border-orange-100">
              <form id="add-alert-form" class="flex flex-col sm:flex-row gap-2"><input type="date" id="alert-date"
                  required class="p-2 border rounded text-sm sm:w-1/3" /><input type="text" id="alert-message"
                  placeholder="Task description..." required class="p-2 border rounded text-sm flex-1" /><button
                  type="submit"
                  class="bg-orange-500 text-white text-sm font-bold px-4 py-2 rounded hover:bg-orange-600">Set
                  Alert</button></form>
            </div>
            <ul id="alert-list-body" class="space-y-1 pl-1"></ul>
          </div>
          <div>
            <div class="flex justify-between items-center border-b pb-1 mb-2">
              <h4 class="font-bold text-blue-700">Payments</h4><span
                class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Total: <span
                  id="total-payment-display">0</span></span>
            </div>
            <div class="bg-blue-50 p-3 rounded mb-3 print-hidden border border-blue-100">
              <form id="add-payment-form" class="grid grid-cols-1 sm:grid-cols-3 gap-2"><input type="date"
                  id="payment-date" required class="p-2 border rounded text-sm" /><input type="number"
                  id="payment-amount" placeholder="Amount" required class="p-2 border rounded text-sm" /><input
                  type="text" id="payment-remarks" placeholder="Notes" class="p-2 border rounded text-sm" /><button
                  type="submit" class="bg-blue-600 text-white text-sm font-bold py-1 rounded sm:col-span-3">Add
                  Payment</button></form>
            </div>
            <table class="w-full text-sm text-left">
              <tbody id="payment-history-body" class="divide-y"></tbody>
            </table>
          </div>
          <div class="mt-8">
            <h4 class="font-bold text-slate-700 mb-2 border-b pb-1">Documents</h4>
            <div class="bg-slate-50 p-3 rounded mb-3 print-hidden border border-slate-200">
              <form id="file-upload-form"><input type="file" id="caseFile" required
                  class="mb-2 w-full text-sm" /><button type="submit" id="upload-btn"
                  class="bg-indigo-600 text-white text-xs font-bold py-2 px-4 rounded hover:bg-indigo-700">Upload</button><span
                  id="upload-status" class="text-xs text-slate-600 ml-2"></span></form>
            </div>
            <div id="case-files-list" class="space-y-2"></div>
          </div>
        </div>
        <div id="report-modal-footer" class="p-4 border-t flex justify-end bg-slate-50 rounded-b-xl"><button
            onclick="window.printReportModal()"
            class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-900"><i
              class="fa-solid fa-print mr-2"></i> Print Report</button></div>
      </div>
    </div>

    <div id="global-schedule-modal"
      class="hidden fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full flex flex-col max-h-[90vh]">
        <div class="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
          <h3 class="font-bold text-indigo-900">Schedule Report</h3><button id="global-schedule-close"
            class="text-2xl text-slate-400 hover:text-red-500">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto" id="global-schedule-body"></div>
        <div class="p-4 border-t flex justify-end"><button onclick="window.printScheduleReport()"
            class="bg-slate-800 text-white px-4 py-2 rounded text-sm">Print</button></div>
      </div>
    </div>
    <div id="global-history-modal"
      class="hidden fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full flex flex-col max-h-[90vh]">
        <div class="p-6 border-b flex justify-between items-center bg-slate-700 rounded-t-xl">
          <h3 class="font-bold text-white">History Report (Past Postings)</h3><button id="global-history-close"
            class="text-2xl text-slate-400 hover:text-red-500">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto" id="global-history-body"></div>
        <div class="p-4 border-t flex justify-end"><button onclick="window.printHistoryReport()"
            class="bg-slate-800 text-white px-4 py-2 rounded text-sm">Print</button></div>
      </div>
    </div>
    <div id="global-payment-modal"
      class="hidden fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full flex flex-col max-h-[90vh]">
        <div class="p-6 border-b flex justify-between items-center bg-blue-50 rounded-t-xl">
          <h3 class="font-bold text-blue-900">Payment Report</h3><button id="global-payment-close"
            class="text-2xl text-slate-400 hover:text-red-500">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-slate-100 text-xs uppercase">
              <tr>
                <th class="p-2">Client</th>
                <th class="p-2 text-right">Total</th>
                <th class="p-2 text-right">Last Date</th>
              </tr>
            </thead>
            <tbody id="global-payment-body" class="divide-y"></tbody>
            <tfoot class="bg-slate-50 font-bold">
              <tr>
                <td class="p-2">TOTAL</td>
                <td class="p-2 text-right" id="grand-total-display">0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
          <p id="no-global-data" class="hidden text-center mt-4">No data</p>
        </div>
        <div class="p-4 border-t flex justify-end"><button onclick="window.print()"
            class="bg-slate-800 text-white px-4 py-2 rounded text-sm">Print</button></div>
      </div>
    </div>
    <div id="global-advocate-modal"
      class="hidden fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full flex flex-col max-h-[90vh]">
        <div class="p-6 border-b flex justify-between items-center bg-purple-50 rounded-t-xl">
          <h3 class="font-bold text-purple-900">Advocate Report</h3><button id="global-advocate-close"
            class="text-2xl text-slate-400 hover:text-red-500">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto" id="global-advocate-body"></div>
        <div class="p-4 border-t flex justify-end"><button onclick="window.print()"
            class="bg-slate-800 text-white px-4 py-2 rounded text-sm">Print</button></div>
      </div>
    </div>
    <div id="global-status-modal"
      class="hidden fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-xl w-full flex flex-col max-h-[90vh]">
        <div class="p-6 border-b flex justify-between items-center bg-orange-50 rounded-t-xl">
          <h3 class="font-bold text-orange-900">Status Report</h3><button id="global-status-close"
            class="text-2xl text-slate-400 hover:text-red-500">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto" id="global-status-body"></div>
        <div class="p-4 border-t flex justify-end"><button onclick="window.print()"
            class="bg-slate-800 text-white px-4 py-2 rounded text-sm">Print</button></div>
      </div>
    </div>

  </main>

  <script type="module">
    // (Imports - Same)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, doc, updateDoc, arrayUnion, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = JSON.parse(typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{"apiKey":"AIzaSyChKU4_9mtTH5PfDuZAlg7FFXtMvVD9-W4","authDomain":"advocate-case-tracker.firebaseapp.com","projectId":"advocate-case-tracker","storageBucket":"advocate-case-tracker.firebasestorage.app","messagingSenderId":"635941080106","appId":"1:635941080106:web:49d5df327250cf7d0e4753"}');
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

    let db, auth, userId, storage, allCasesData = [], currentReportCaseId = null;
    const userRole = localStorage.getItem('userRole');
    const getEl = (id) => document.getElementById(id);
    const formatDate = (d) => { const date = new Date(d); return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; };
    const getStatusClass = (s) => { const map = { 'Filed': 'status-filed', 'Hearing': 'status-hearing', 'Judgment Reserved': 'status-judgment', 'Disposed': 'status-disposed', 'Adjourned': 'status-adjourned', 'Achieved': 'status-disposed', 'Give up': 'status-default' }; return map[s] || 'bg-gray-100 text-gray-700'; };

    document.getElementById('sign-out-btn').addEventListener('click', async () => { try { localStorage.removeItem('userRole'); localStorage.removeItem('userEmail'); await signOut(auth); } catch (error) { console.error("Sign Out Error:", error.message); } });

    try {
      const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);
      onAuthStateChanged(auth, (user) => {
        if (user && userRole) {
          userId = user.uid; listenForCases(); loadAdvocates();
          if (userRole === 'admin') getEl("report-buttons-container").classList.remove("hidden");
          else getEl("report-buttons-container").classList.add("hidden");
        } else { window.location.replace('login.html'); }
      });
    } catch (e) { console.error(e); }

    function loadAdvocates() {
      if (!userId) return;
      onSnapshot(query(collection(db, "artifacts", appId, "advocates"), orderBy("name")), (snapshot) => {
        const selectHistory = document.getElementById("history-advocate");
        const selectFilter = document.getElementById("filterAdvocate");
        selectHistory.innerHTML = '<option value="" disabled selected>Select Advocate</option>';
        selectFilter.innerHTML = '<option value="">All Advocates</option>';
        snapshot.forEach((doc) => {
          const data = doc.data();
          const opt1 = document.createElement("option"); opt1.value = data.name; opt1.textContent = data.name; selectHistory.appendChild(opt1);
          const opt2 = document.createElement("option"); opt2.value = data.name; opt2.textContent = data.name; selectFilter.appendChild(opt2);
        });
      });
    }

    function listenForCases() {
      if (!userId) return;
      onSnapshot(query(collection(db, "artifacts", appId, "cases")), (snapshot) => {
        const cases = [];
        snapshot.forEach((doc) => cases.push({ id: doc.id, ...doc.data() }));
        // Sort: Cases with valid dates first, then invalid (Filed)
        cases.sort((a, b) => {
          if (!a.scheduledDate) return 1;
          if (!b.scheduledDate) return -1;
          return new Date(a.scheduledDate) - new Date(b.scheduledDate);
        });
        allCasesData = cases;
        applyFilters();
      });
    }

    // --- RENDER CASES (Updated for "Not Scheduled") ---
    function renderCaseList(cases) {
      const tbody = getEl("cases-list"); getEl("case-count").textContent = `${cases.length} Cases found`; tbody.innerHTML = "";
      if (cases.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-400">No cases match your filters.</td></tr>'; }

      const today = formatDate(Date.now()); const tmrw = formatDate(new Date(Date.now() + 86400000));
      let activeCount = 0; let tmrwCount = 0; let alertsForWidget = [];

      cases.forEach(c => {
        // Status Count Logic
        if (c.caseStatus !== 'Disposed' && c.caseStatus !== 'Achieved' && c.caseStatus !== 'Give up') activeCount++;

        // Tomorrow Count Logic (Only valid dates)
        if (c.scheduledDate && c.scheduledDate === tmrw) tmrwCount++;

        if (c.alerts) c.alerts.forEach((a, index) => { if ((a.status || 'Pending') === 'Pending') alertsForWidget.push({ caseId: c.id, alertIndex: index, caseNo: c.caseNumber, client: c.clientName, msg: a.message, date: a.date }); });

        const contact = c.contactNumber ? `<div class="text-xs text-slate-400 mt-1"><i class="fa-solid fa-phone mr-1"></i>${c.contactNumber}</div>` : "";
        const deleteBtn = userRole === 'admin' ? `<button onclick="window.deleteCase('${c.id}')" class="text-slate-400 hover:text-red-600 transition p-2" title="Delete"><i class="fa-solid fa-trash-can"></i></button>` : '';

        // Date Display Logic
        let dateHtml = '';
        if (!c.scheduledDate) {
          dateHtml = `<div class="text-sm font-medium text-slate-400">Not Scheduled</div><div class="text-[10px] text-slate-400">Filed: ${c.filingDate || '-'}</div>`;
        } else {
          dateHtml = `<div class="text-sm font-medium ${c.scheduledDate === today ? 'text-orange-600 font-bold' : (c.scheduledDate === tmrw ? 'text-teal-600 font-bold' : 'text-slate-600')}">${c.scheduledDate}</div>${c.scheduledDate === tmrw ? '<div class="text-[10px] uppercase font-bold text-teal-500">Tomorrow</div>' : ''}${c.scheduledDate === today ? '<div class="text-[10px] uppercase font-bold text-orange-500">Today</div>' : ''}`;
        }

        const tr = document.createElement("tr"); tr.className = "hover:bg-slate-50 transition-colors group";
        tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-bold text-slate-900">${c.caseNumber}</div><div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-building-columns mr-1"></i> ${c.courtName}</div></td><td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center"><div class="h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold text-xs mr-3 border border-slate-300">${c.clientName.charAt(0).toUpperCase()}</div><div><div class="text-sm font-medium text-slate-900">${c.clientName}</div>${contact}</div></div></td><td class="px-6 py-4 whitespace-nowrap">${dateHtml}</td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2.5 py-0.5 rounded-full text-xs font-semibold border border-transparent ${getStatusClass(c.caseStatus)}">${c.caseStatus}</span></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="window.openReport('${c.id}')" class="text-slate-400 hover:text-indigo-600 mx-1 p-2" title="View Report"><i class="fa-regular fa-file-lines text-lg"></i></button><button onclick="window.openEdit('${c.id}')" class="text-slate-400 hover:text-teal-600 mx-1 p-2" title="Edit"><i class="fa-solid fa-pen text-lg"></i></button>${deleteBtn}</td>`;
        tbody.appendChild(tr);
      });

      getEl("widget-tomorrow-count").textContent = tmrwCount; getEl("tomorrow-cases-list-widget").textContent = tmrwCount > 0 ? "Check notifications below" : "No postings tomorrow";
      getEl("widget-active-count").textContent = activeCount; getEl("widget-alert-count").textContent = alertsForWidget.length;

      alertsForWidget.sort((a, b) => { if (a.date === today && b.date !== today) return -1; if (a.date !== today && b.date === today) return 1; return new Date(a.date) - new Date(b.date); });
      if (alertsForWidget.length > 0) { getEl("alert-panel").classList.remove("hidden"); getEl("today-alerts-list").innerHTML = alertsForWidget.map(a => `<div class='p-2 bg-slate-50 border ${a.date < today ? 'border-red-300' : 'border-slate-200'} rounded text-xs flex justify-between items-center group hover:bg-white transition'><div class="truncate mr-2"><span class="font-bold ${a.date < today ? 'text-red-600' : 'text-orange-600'}">${a.date}:</span> ${a.msg} <span class="text-slate-400 ml-1">(${a.caseNo})</span></div><button onclick="window.acknowledgeAlert('${a.caseId}', ${a.alertIndex})" class="opacity-0 group-hover:opacity-100 transition-opacity bg-teal-500 text-white text-[10px] font-bold px-2 py-0.5 rounded hover:bg-teal-600">Done</button></div>`).join(''); } else { getEl("alert-panel").classList.add("hidden"); getEl("today-alerts-list").innerHTML = ""; }
    }

    function getFilteredCases() {
      const fFrom = getEl("filterDateFrom").value; const fTo = getEl("filterDateTo").value; const fAdv = getEl("filterAdvocate").value;
      const fNo = (getEl("searchCaseNumber").value || "").toLowerCase().trim(); const fClient = (getEl("searchClientName").value || "").toLowerCase().trim(); const fCourt = (getEl("searchCourtName").value || "").toLowerCase().trim();
      return allCasesData.filter(c => {
        const d = c.scheduledDate || "";
        // If date filter is active, exclude unscheduled cases
        if ((fFrom || fTo) && !d) return false;

        let ok = true;
        if (fFrom && d < fFrom) ok = false; if (fTo && d > fTo) ok = false;
        if (fAdv && c.advocateName !== fAdv) ok = false;
        if (fNo && !String(c.caseNumber || "").toLowerCase().includes(fNo)) ok = false;
        if (fClient && !String(c.clientName || "").toLowerCase().includes(fClient)) ok = false;
        if (fCourt && !String(c.courtName || "").toLowerCase().includes(fCourt)) ok = false;
        return ok;
      });
    }
    function applyFilters() { renderCaseList(getFilteredCases()); }
    ["filterDateFrom", "filterDateTo", "filterAdvocate", "searchCaseNumber", "searchClientName", "searchCourtName"].forEach(id => getEl(id).addEventListener("input", applyFilters));
    getEl("clear-filter").addEventListener("click", () => { ["filterDateFrom", "filterDateTo", "searchCaseNumber", "searchClientName", "searchCourtName", "filterAdvocate"].forEach(id => getEl(id).value = ""); applyFilters(); });

    // --- REPORTS ---
    getEl("generate-status-report").addEventListener("click", () => { const currentFilteredCases = getFilteredCases(); const statusCounts = currentFilteredCases.reduce((acc, c) => { const s = c.caseStatus || 'Unknown'; acc[s] = (acc[s] || 0) + 1; return acc; }, {}); let html = `<div class="mb-4 text-xs text-gray-500">Based on ${currentFilteredCases.length} visible cases</div><table class="w-full text-left border text-sm"><thead class="bg-gray-100"><tr><th class="p-2">Status</th><th class="p-2">Count</th></tr></thead><tbody>`; if (currentFilteredCases.length === 0) html += `<tr><td colspan="2" class="p-4 text-center text-gray-500">No cases found.</td></tr>`; else Object.keys(statusCounts).forEach(s => html += `<tr class="border-b"><td class="p-2 font-bold">${s}</td><td class="p-2">${statusCounts[s]}</td></tr>`); html += `</tbody></table>`; getEl("global-status-body").innerHTML = html; getEl("global-status-modal").classList.remove("hidden"); });
    getEl("generate-advocate-report").addEventListener("click", () => { const fFrom = getEl("filterDateFrom").value; const fTo = getEl("filterDateTo").value; const fAdv = getEl("filterAdvocate").value; const advMap = {}; allCasesData.forEach(c => { if (c.hearingHistory) c.hearingHistory.forEach(h => { const hDate = h.date || h.nextPostingDate; if (fFrom && hDate < fFrom) return; if (fTo && hDate > fTo) return; if (fAdv && h.appearedAdvocate !== fAdv) return; if (h.appearedAdvocate) { if (!advMap[h.appearedAdvocate]) advMap[h.appearedAdvocate] = []; advMap[h.appearedAdvocate].push({ date: hDate, caseNo: c.caseNumber, remarks: h.remarks }); } }); }); let html = ""; if (fAdv) html += `<div class="mb-4 text-sm font-bold text-teal-700">Showing report for: ${fAdv}</div>`; if (Object.keys(advMap).length === 0) html += "<p class='text-center text-gray-500 mt-4'>No appearance history found.</p>"; else Object.keys(advMap).forEach(adv => { html += `<h4 class="font-bold bg-gray-100 p-2 mt-2 border-l-4 border-purple-500">${adv}</h4><table class="w-full text-xs text-left border mb-2"><tbody>`; advMap[adv].forEach(r => html += `<tr class="border-b"><td class="p-2 w-24">${r.date}</td><td class="p-2 font-bold w-32">${r.caseNo}</td><td class="p-2 italic">${r.remarks}</td></tr>`); html += `</tbody></table>`; }); getEl("global-advocate-body").innerHTML = html; getEl("global-advocate-modal").classList.remove("hidden"); });

    // --- HISTORY REPORT (STRICT FUTURE FILTER) ---
    getEl("generate-history-report").addEventListener("click", () => {
      const fFrom = getEl("filterDateFrom").value;
      const fTo = getEl("filterDateTo").value;
      const fAdv = getEl("filterAdvocate").value;

      const historyData = [];
      let totalAppearances = 0;
      const today = new Date();

      allCasesData.forEach(c => {
        if (c.hearingHistory) {
          c.hearingHistory.forEach(h => {
            const hDateStr = h.postingDate || (h.addedAt ? formatDate(h.addedAt) : null);
            if (!hDateStr) return;

            // STRICT: Do NOT show future dates
            const hDateObj = new Date(hDateStr);
            if (hDateObj > today) return;

            // Filters
            if (fFrom && hDateStr < fFrom) return;
            if (fTo && hDateStr > fTo) return;
            if (fAdv && h.appearedAdvocate !== fAdv) return;

            if (fAdv) totalAppearances++;

            historyData.push({
              date: hDateStr,
              caseNo: c.caseNumber,
              client: c.clientName,
              advocate: h.appearedAdvocate || '-',
              status: h.status,
              remarks: h.remarks,
              nextDate: h.nextPostingDate || h.date || '-'
            });
          });
        }
      });

      historyData.sort((a, b) => new Date(b.date) - new Date(a.date));

      let header = `<div class="mb-3 flex justify-between text-sm text-slate-300 border-b border-slate-600 pb-2"><span>Range: ${fFrom || 'Start'} to ${fTo || 'Now'}</span>`;
      if (fAdv) header += `<span class="font-bold text-green-400">${fAdv}: ${totalAppearances} Appearances</span>`;
      header += `</div>`;

      let html = header + `<table class="w-full text-left border border-slate-600 text-sm text-slate-200"><thead class="bg-slate-800 text-xs uppercase"><tr><th class="p-2">Date</th><th class="p-2">Case No</th><th class="p-2">Advocate</th><th class="p-2">Status</th><th class="p-2">Remarks</th><th class="p-2">Next Date</th></tr></thead><tbody>`;

      if (historyData.length === 0) html += `<tr><td colspan="6" class="p-4 text-center text-slate-400">No past history records found.</td></tr>`;
      else {
        historyData.forEach(r => {
          html += `<tr class="border-b border-slate-600"><td class="p-2 font-bold text-orange-400">${r.date}</td><td class="p-2">${r.caseNo}<br><span class="text-[10px] text-slate-400">${r.client}</span></td><td class="p-2 text-teal-300">${r.advocate}</td><td class="p-2">${r.status}</td><td class="p-2 italic text-slate-400">${r.remarks}</td><td class="p-2">${r.nextDate}</td></tr>`;
        });
      }
      html += `</tbody></table>`;
      getEl("global-history-body").innerHTML = html;
      getEl("global-history-modal").classList.remove("hidden");
    });

    // Standard Functions (Same)
    window.deleteCase = async (id) => { const role = localStorage.getItem('userRole'); if (role !== 'admin') { alert("Unauthorized"); return; } if (confirm("Delete this case?")) { try { await deleteDoc(doc(db, "artifacts", appId, "cases", id)); } catch (error) { alert("Error: " + error.message); } } };
    window.acknowledgeAlert = async (caseId, alertIndex) => { if (!userId) return; const c = allCasesData.find(x => x.id === caseId); if (!c || !c.alerts) return; let up = [...c.alerts]; up[alertIndex] = { ...up[alertIndex], status: 'Completed', acknowledgedAt: Date.now() }; await updateDoc(doc(db, "artifacts", appId, "cases", caseId), { alerts: up }); };
    getEl("generate-schedule-report").addEventListener("click", () => { const fFrom = getEl("filterDateFrom").value; const fTo = getEl("filterDateTo").value; const data = allCasesData.filter(c => { if (fFrom && c.scheduledDate < fFrom) return false; if (fTo && c.scheduledDate > fTo) return false; return true; }); data.sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate)); const tbody = document.createElement("tbody"); if (data.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">No cases found.</td></tr>'; else { data.forEach(c => { let rem = c.caseStatus; if (c.hearingHistory) { const h = c.hearingHistory.find(x => x.date === c.scheduledDate); if (h && h.remarks) rem = `<span class="font-bold">${h.status}</span>: ${h.remarks}`; } tbody.innerHTML += `<tr class="border-b text-sm"><td class="p-2 font-bold">${c.scheduledDate}</td><td class="p-2">${c.clientName}</td><td class="p-2">${c.caseNumber}</td><td class="p-2">${c.courtName}</td><td class="p-2 italic">${rem}</td></tr>`; }); } getEl("global-schedule-body").innerHTML = `<table class="w-full text-left border"><thead class="bg-gray-100"><tr><th class="p-2">Date</th><th class="p-2">Client</th><th class="p-2">Case No</th><th class="p-2">Court</th><th class="p-2">Status</th></tr></thead>${tbody.innerHTML}</table>`; getEl("global-schedule-modal").classList.remove("hidden"); });
    getEl("generate-payment-report").addEventListener("click", () => { const fFrom = getEl("filterDateFrom").value; const fTo = getEl("filterDateTo").value; const totals = {}; let grand = 0; allCasesData.forEach(c => { if (c.paymentHistory) c.paymentHistory.forEach(p => { if (fFrom && p.date < fFrom) return; if (fTo && p.date > fTo) return; const amt = parseFloat(p.amount) || 0; if (amt > 0) { if (!totals[c.clientName]) totals[c.clientName] = { t: 0, d: p.date }; totals[c.clientName].t += amt; if (p.date > totals[c.clientName].d) totals[c.clientName].d = p.date; grand += amt; } }); }); const body = getEl("global-payment-body"); body.innerHTML = ""; const arr = Object.entries(totals).map(([n, d]) => ({ name: n, ...d })).sort((a, b) => b.t - a.t); if (arr.length === 0) getEl("no-global-data").classList.remove("hidden"); else { getEl("no-global-data").classList.add("hidden"); arr.forEach(r => { body.innerHTML += `<tr class="border-b"><td class="p-2 font-medium">${r.name}</td><td class="p-2 text-right font-bold text-green-600">${r.t.toLocaleString()}</td><td class="p-2 text-right text-xs text-gray-500">${r.d}</td></tr>`; }); } getEl("grand-total-display").textContent = grand.toLocaleString(); getEl("global-payment-modal").classList.remove("hidden"); });
    getEl("global-schedule-close").addEventListener("click", () => getEl("global-schedule-modal").classList.add("hidden")); getEl("global-status-close").addEventListener("click", () => getEl("global-status-modal").classList.add("hidden")); getEl("global-payment-close").addEventListener("click", () => getEl("global-payment-modal").classList.add("hidden")); getEl("global-advocate-close").addEventListener("click", () => getEl("global-advocate-modal").classList.add("hidden")); getEl("global-history-close").addEventListener("click", () => getEl("global-history-modal").classList.add("hidden"));

    window.openEdit = (id) => { const c = allCasesData.find(x => x.id === id); if (!c) return; getEl("edit-caseId").value = c.id; getEl("edit-caseNumber").value = c.caseNumber; getEl("edit-advocateName").value = c.advocateName; getEl("edit-courtName").value = c.courtName; getEl("edit-clientName").value = c.clientName; getEl("edit-scheduledDate").value = c.scheduledDate; getEl("edit-caseStatus").value = c.caseStatus; getEl("edit-contactNumber").value = c.contactNumber || ""; getEl("edit-referralName").value = c.referralName || ""; getEl("edit-oppositeAdvocate").value = c.oppositeAdvocate || ""; getEl("edit-oppositeAdvocateMobile").value = c.oppositeAdvocateMobile || ""; getEl("edit-alternativeContactNumber").value = c.alternativeContactNumber || ""; getEl("edit-clientEmail").value = c.clientEmail || ""; getEl("edit-clientAddress").value = c.clientAddress || ""; getEl("edit-clientPincode").value = c.clientPincode || ""; getEl("edit-modal").classList.remove("hidden"); }; getEl("edit-modal-cancel").addEventListener("click", () => getEl("edit-modal").classList.add("hidden"));
    getEl("edit-case-form").addEventListener("submit", async (e) => { e.preventDefault(); if (!userId) return; const id = getEl("edit-caseId").value; await updateDoc(doc(db, "artifacts", appId, "cases", id), { advocateName: getEl("edit-advocateName").value, courtName: getEl("edit-courtName").value, clientName: getEl("edit-clientName").value, scheduledDate: getEl("edit-scheduledDate").value, caseStatus: getEl("edit-caseStatus").value, contactNumber: getEl("edit-contactNumber").value, referralName: getEl("edit-referralName").value, oppositeAdvocate: getEl("edit-oppositeAdvocate").value, oppositeAdvocateMobile: getEl("edit-oppositeAdvocateMobile").value, alternativeContactNumber: getEl("edit-alternativeContactNumber").value, clientEmail: getEl("edit-clientEmail").value, clientAddress: getEl("edit-clientAddress").value, clientPincode: getEl("edit-clientPincode").value }); getEl("edit-modal").classList.add("hidden"); });
    window.openReport = (id) => { currentReportCaseId = id; const c = allCasesData.find(x => x.id === id); if (c) { loadReportData(c); getEl("upload-status").textContent = ""; getEl("file-upload-form").reset(); } getEl("report-modal").classList.remove("hidden"); }; getEl("report-modal-close").addEventListener("click", () => { getEl("report-modal").classList.add("hidden"); currentReportCaseId = null; });
    function loadReportData(c) { getEl("report-case-title").textContent = `Case: ${c.caseNumber}`; getEl("report-client-subtitle").textContent = `${c.clientName} | ${c.courtName}`; getEl("report-client-details").innerHTML = `<div><span class="font-bold">Contact:</span> ${c.contactNumber || '-'}</div><div><span class="font-bold">Alt. Contact:</span> ${c.alternativeContactNumber || '-'}</div><div><span class="font-bold">Email:</span> ${c.clientEmail || '-'}</div><div><span class="font-bold">Pincode:</span> ${c.clientPincode || '-'}</div><div class="sm:col-span-2"><span class="font-bold">Address:</span> ${c.clientAddress || '-'}</div>`; getEl("current-hearing-date").value = formatDate(Date.now()); const hList = c.hearingHistory || []; hList.sort((a, b) => new Date(b.date || b.nextPostingDate) - new Date(a.date || a.nextPostingDate)); getEl("hearing-history-body").innerHTML = hList.length ? hList.map(h => { const pDate = h.postingDate || (h.addedAt ? formatDate(h.addedAt) : '-'); const nDate = h.nextPostingDate || h.date || '-'; return `<tr><td class="p-2">${pDate}</td><td class="p-2 font-bold text-slate-700">${h.appearedAdvocate || '-'}</td><td class="p-2 text-xs text-slate-500"><div>${h.status}</div><div class="italic">${h.remarks}</div></td><td class="p-2">${nDate}</td></tr>`; }).join('') : ""; getEl("no-history-msg").style.display = hList.length ? "none" : "block"; const pList = c.paymentHistory || []; pList.sort((a, b) => new Date(b.date) - new Date(a.date)); let total = 0; getEl("payment-history-body").innerHTML = pList.length ? pList.map(p => { total += parseFloat(p.amount) || 0; return `<tr><td class="p-2">${p.date}</td><td class="p-2 text-green-600 font-bold">${p.amount}</td><td class="p-2 text-slate-500">${p.remarks}</td></tr>`; }).join('') : ""; getEl("total-payment-display").textContent = total; const fList = c.caseFiles || []; getEl("case-files-list").innerHTML = fList.length ? fList.map(f => `<div class='flex justify-between p-2 bg-slate-50 border rounded text-sm'><div class="truncate"><i class="fa-solid fa-paperclip text-slate-400 mr-2"></i>${f.name}</div><a href="${f.url}" target="_blank" class="text-indigo-600 font-bold text-xs">Download</a></div>`).join('') : '<p class="text-xs text-slate-400 mt-2">No documents.</p>'; const aList = c.alerts || []; const pen = aList.filter(a => (a.status || 'Pending') === 'Pending'); pen.sort((a, b) => new Date(a.date) - new Date(b.date)); getEl("alert-list-body").innerHTML = pen.length ? pen.map(a => { const idx = c.alerts.findIndex(x => x.message === a.message && x.date === a.date); return `<li class="text-sm text-slate-700 bg-slate-50 border p-2 rounded flex justify-between items-center mb-1"><span><span class="font-bold text-orange-600">${a.date}:</span> ${a.message}</span><button onclick="window.acknowledgeAlert('${c.id}',${idx})" class="ml-2 bg-teal-500 text-white text-xs font-bold px-3 py-1 rounded">OK</button></li>`; }).join('') : "<li class='text-xs text-slate-400'>No active alerts.</li>"; }
    getEl("add-history-form").addEventListener("submit", async (e) => { e.preventDefault(); if (!currentReportCaseId || !userId) return; const hDate = getEl("current-hearing-date").value; const next = getEl("history-date").value; const s = getEl("history-status").value; const adv = getEl("history-advocate").value; const r = getEl("history-remarks").value; await updateDoc(doc(db, "artifacts", appId, "cases", currentReportCaseId), { scheduledDate: next, caseStatus: s, hearingHistory: arrayUnion({ postingDate: hDate, nextPostingDate: next, date: next, status: s, appearedAdvocate: adv, remarks: r, addedAt: Date.now() }) }); e.target.reset(); getEl("current-hearing-date").value = formatDate(Date.now()); });
    getEl("add-payment-form").addEventListener("submit", async (e) => { e.preventDefault(); if (!currentReportCaseId || !userId) return; await updateDoc(doc(db, "artifacts", appId, "cases", currentReportCaseId), { paymentHistory: arrayUnion({ date: getEl("payment-date").value, amount: getEl("payment-amount").value, remarks: getEl("payment-remarks").value, addedAt: Date.now() }), feePaid: getEl("payment-amount").value }); e.target.reset(); });
    getEl("add-alert-form").addEventListener("submit", async (e) => { e.preventDefault(); if (!currentReportCaseId || !userId) return; await updateDoc(doc(db, "artifacts", appId, "cases", currentReportCaseId), { alerts: arrayUnion({ date: getEl("alert-date").value, message: getEl("alert-message").value, status: 'Pending', addedAt: Date.now() }) }); e.target.reset(); });
    getEl("file-upload-form").addEventListener("submit", async (e) => { e.preventDefault(); if (!userId) return; const fi = getEl("caseFile"); const us = getEl("upload-status"); const btn = getEl("upload-btn"); if (!fi.files.length) { us.textContent = "Select file"; return; } const f = fi.files[0]; const refS = ref(storage, `${currentReportCaseId}/${Date.now()}_${f.name}`); const task = uploadBytesResumable(refS, f); btn.disabled = true; task.on('state_changed', null, null, async () => { const url = await getDownloadURL(task.snapshot.ref); await updateDoc(doc(db, "artifacts", appId, "cases", currentReportCaseId), { caseFiles: arrayUnion({ name: f.name, url: url, date: formatDate(Date.now()), uploadedBy: userId }) }); us.textContent = "Done"; fi.value = ''; btn.disabled = false; }); });
    window.printReportModal = () => { const c = document.getElementById('report-modal').querySelector('.bg-white').cloneNode(true); c.querySelectorAll('.print-hidden, form, button').forEach(e => e.remove()); const w = window.open('', '_blank'); w.document.write(`<html><head><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px}th,td{border:1px solid #ddd;padding:5px}th{background:#eee}</style></head><body>${c.innerHTML}</body></html>`); w.document.close(); setTimeout(() => { w.print(); w.close(); }, 500); };
    window.printScheduleReport = () => { const c = getEl("global-schedule-body").innerHTML; const w = window.open('', '_blank'); w.document.write(`<html><head><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse;font-size:12px}th,td{border:1px solid #ccc;padding:5px;text-align:left}th{background:#f0f0f0}</style></head><body><h2>Schedule Report</h2>${c}</body></html>`); w.document.close(); setTimeout(() => { w.print(); w.close(); }, 500); };
    window.printHistoryReport = () => { const c = getEl("global-history-body").innerHTML; const w = window.open('', '_blank'); w.document.write(`<html><head><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse;font-size:12px;color:white}th,td{border:1px solid #555;padding:5px;text-align:left}th{background:#333}body{background-color:#222;color:#fff}</style></head><body><h2>History Report</h2>${c}</body></html>`); w.document.close(); setTimeout(() => { w.print(); w.close(); }, 500); };
  </script>
</body>

</html>